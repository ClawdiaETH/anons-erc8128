class j extends Error{code;constructor(R,$){super($);this.code=R;this.name="Erc8128Error"}}/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function N8(R){return R instanceof Uint8Array||ArrayBuffer.isView(R)&&R.constructor.name==="Uint8Array"}function h(R,...$){if(!N8(R))throw Error("Uint8Array expected");if($.length>0&&!$.includes(R.length))throw Error("Uint8Array expected of length "+$+", got length="+R.length)}function YR(R,$=!0){if(R.destroyed)throw Error("Hash instance has been destroyed");if($&&R.finished)throw Error("Hash#digest() has already been called")}function WR(R,$){h(R);let Y=$.outputLen;if(R.length<Y)throw Error("digestInto() expects output buffer of length at least "+Y)}function u(...R){for(let $=0;$<R.length;$++)R[$].fill(0)}function o(R){return new DataView(R.buffer,R.byteOffset,R.byteLength)}function x(R,$){return R<<32-$|R>>>$}function J8(R){if(typeof R!=="string")throw Error("string expected");return new Uint8Array(new TextEncoder().encode(R))}function ZR(R){if(typeof R==="string")R=J8(R);return h(R),R}class KR{}function IR(R){let $=(Z)=>R().update(ZR(Z)).digest(),Y=R();return $.outputLen=Y.outputLen,$.blockLen=Y.blockLen,$.create=()=>R(),$}function X8(R,$,Y,Z){if(typeof R.setBigUint64==="function")return R.setBigUint64($,Y,Z);let K=BigInt(32),N=BigInt(4294967295),J=Number(Y>>K&N),X=Number(Y&N),z=Z?4:0,U=Z?0:4;R.setUint32($+z,J,Z),R.setUint32($+U,X,Z)}function LR(R,$,Y){return R&$^~R&Y}function VR(R,$,Y){return R&$^R&Y^$&Y}class NR extends KR{constructor(R,$,Y,Z){super();this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=R,this.outputLen=$,this.padOffset=Y,this.isLE=Z,this.buffer=new Uint8Array(R),this.view=o(this.buffer)}update(R){YR(this),R=ZR(R),h(R);let{view:$,buffer:Y,blockLen:Z}=this,K=R.length;for(let N=0;N<K;){let J=Math.min(Z-this.pos,K-N);if(J===Z){let X=o(R);for(;Z<=K-N;N+=Z)this.process(X,N);continue}if(Y.set(R.subarray(N,N+J),this.pos),this.pos+=J,N+=J,this.pos===Z)this.process($,0),this.pos=0}return this.length+=R.length,this.roundClean(),this}digestInto(R){YR(this),WR(R,this),this.finished=!0;let{buffer:$,view:Y,blockLen:Z,isLE:K}=this,{pos:N}=this;if($[N++]=128,u(this.buffer.subarray(N)),this.padOffset>Z-N)this.process(Y,0),N=0;for(let Q=N;Q<Z;Q++)$[Q]=0;X8(Y,Z-8,BigInt(this.length*8),K),this.process(Y,0);let J=o(R),X=this.outputLen;if(X%4)throw Error("_sha2: outputLen should be aligned to 32bit");let z=X/4,U=this.get();if(z>U.length)throw Error("_sha2: outputLen bigger than state");for(let Q=0;Q<z;Q++)J.setUint32(4*Q,U[Q],K)}digest(){let{buffer:R,outputLen:$}=this;this.digestInto(R);let Y=R.slice(0,$);return this.destroy(),Y}_cloneInto(R){R||(R=new this.constructor),R.set(...this.get());let{blockLen:$,buffer:Y,length:Z,finished:K,destroyed:N,pos:J}=this;if(R.destroyed=N,R.finished=K,R.length=Z,R.pos=J,Z%$)R.buffer.set(Y);return R}clone(){return this._cloneInto()}}var W=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var z8=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),L=new Uint32Array(64);class BR extends NR{constructor(R=32){super(64,R,8,!1);this.A=W[0]|0,this.B=W[1]|0,this.C=W[2]|0,this.D=W[3]|0,this.E=W[4]|0,this.F=W[5]|0,this.G=W[6]|0,this.H=W[7]|0}get(){let{A:R,B:$,C:Y,D:Z,E:K,F:N,G:J,H:X}=this;return[R,$,Y,Z,K,N,J,X]}set(R,$,Y,Z,K,N,J,X){this.A=R|0,this.B=$|0,this.C=Y|0,this.D=Z|0,this.E=K|0,this.F=N|0,this.G=J|0,this.H=X|0}process(R,$){for(let Q=0;Q<16;Q++,$+=4)L[Q]=R.getUint32($,!1);for(let Q=16;Q<64;Q++){let f=L[Q-15],G=L[Q-2],P=x(f,7)^x(f,18)^f>>>3,k=x(G,17)^x(G,19)^G>>>10;L[Q]=k+L[Q-7]+P+L[Q-16]|0}let{A:Y,B:Z,C:K,D:N,E:J,F:X,G:z,H:U}=this;for(let Q=0;Q<64;Q++){let f=x(J,6)^x(J,11)^x(J,25),G=U+f+LR(J,X,z)+z8[Q]+L[Q]|0,k=(x(Y,2)^x(Y,13)^x(Y,22))+VR(Y,Z,K)|0;U=z,z=X,X=J,J=N+G|0,N=K,K=Z,Z=Y,Y=G+k|0}Y=Y+this.A|0,Z=Z+this.B|0,K=K+this.C|0,N=N+this.D|0,J=J+this.E|0,X=X+this.F|0,z=z+this.G|0,U=U+this.H|0,this.set(Y,Z,K,N,J,X,z,U)}roundClean(){u(L)}destroy(){this.set(0,0,0,0,0,0,0,0),u(this.buffer)}}var vR=IR(()=>new BR);var w="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Q8=(()=>{let R=new Uint8Array(256);R.fill(255);for(let $=0;$<w.length;$++)R[w.charCodeAt($)]=$;return R[45]=62,R[95]=63,R})();function gR(R,$){if(R instanceof Request)return $?new Request(R,$):R;return new Request(R,$)}function JR(R){return typeof R==="object"&&R!==null&&typeof R.signMessage==="function"}function y(R){try{return new URL(R)}catch{throw new j("UNSUPPORTED_REQUEST",`Request.url must be absolute (got: ${R}).`)}}function l(){return Math.floor(Date.now()/1000)}function yR(R){return new TextEncoder().encode(R)}function SR(R){let $=globalThis.crypto;if(!$?.getRandomValues)throw new j("CRYPTO_UNAVAILABLE","crypto.getRandomValues required.");let Y=new Uint8Array(R);return $.getRandomValues(Y),Y}async function XR(R){try{let Y=await R.clone().arrayBuffer();return new Uint8Array(Y)}catch{throw new j("BODY_READ_FAILED","Failed to read request body (stream locked/disturbed).")}}async function zR(R){return vR(R)}function S(R){let $="",Y=0;for(;Y+2<R.length;Y+=3){let K=R[Y]<<16|R[Y+1]<<8|R[Y+2];$+=w[K>>18&63]+w[K>>12&63]+w[K>>6&63]+w[K&63]}if(Y===R.length)return $;let Z=R[Y]<<16;if(Y+1<R.length){let K=Z|R[Y+1]<<8;$+=w[K>>18&63]+w[K>>12&63]+w[K>>6&63]+"="}else $+=`${w[Z>>18&63]+w[Z>>12&63]}==`;return $}function _R(R){try{let $=R.trim().replace(/=+$/g,"");if($.length===0)return new Uint8Array(0);if($.length%4===1)return null;let Y=new Uint8Array(Math.floor($.length*3/4)),Z=0,K=0,N=0;for(let J=0;J<$.length;J++){let X=Q8[$.charCodeAt(J)];if(X===255)return null;if(Z=Z<<6|X,K+=6,K>=8)K-=8,Y[N++]=Z>>K&255}return N===Y.length?Y:Y.slice(0,N)}catch{return null}}function ER(R){return S(R).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function HR(R){let $=R.slice(2);if($.length%2!==0)throw new j("UNSUPPORTED_REQUEST","Invalid hex length.");let Y=new Uint8Array($.length/2);for(let Z=0;Z<Y.length;Z++)Y[Z]=parseInt($.slice(Z*2,Z*2+2),16);return Y}function QR(R){let $="0x";for(let Y of R)$+=Y.toString(16).padStart(2,"0");return $}async function UR(R,$){let Y=new Headers(R.headers),Z=Y.get("content-digest");if($==="off")throw new j("DIGEST_REQUIRED","content-digest is required by covered components, but contentDigest='off'.");if($==="require"&&!Z)throw new j("DIGEST_REQUIRED","content-digest is required but missing.");if(Z&&$==="auto")return R;let K=await XR(R),N=await zR(K),J=S(N);return Y.set("content-digest",`sha-256=:${J}:`),new Request(R,{headers:Y})}async function bR(R){let $=R.headers.get("content-digest");if(!$)return!1;let Y=U8($);if(!Y)return!1;if(Y.alg!=="sha-256")return!1;let Z=await XR(R),K=await zR(Z),N=S(K);return j8(Y.b64,N)}function U8(R){let $=R.trim(),Y=/^([A-Za-z0-9_-]+)=:([A-Za-z0-9+/]+={0,2}):$/.exec($);if(!Y)return null;return{alg:Y[1].toLowerCase(),b64:Y[2]}}function j8(R,$){if(R.length!==$.length)return!1;let Y=0;for(let Z=0;Z<R.length;Z++)Y|=R.charCodeAt(Z)^$.charCodeAt(Z);return Y===0}function mR(R){let $=[];for(let Y of pR(R)){let Z=Y.trim();if(!Z)continue;let K=Z.indexOf("=");if(K<=0)throw new j("PARSE_ERROR","Invalid Signature-Input member (missing '=').");let N=Z.slice(0,K).trim();c(N);let J=Z.slice(K+1).trim(),X=J,z=M8(J);$.push({label:N,components:z.items,params:z.params,signatureParamsValue:X})}return $}function AR(R){let $=new Map;for(let Y of pR(R)){let Z=Y.trim();if(!Z)continue;let K=Z.indexOf("=");if(K<=0)throw new j("PARSE_ERROR","Invalid Signature member (missing '=').");let N=Z.slice(0,K).trim();c(N);let J=Z.slice(K+1).trim(),X=f8(J);$.set(N,X)}return $}function f8(R){let $=R.trim();if(!$.startsWith(":")||!$.endsWith(":")||$.length<3)throw new j("PARSE_ERROR","Invalid sf-binary.");let Y=$.slice(1,-1);if(!/^[A-Za-z0-9+/]+={0,2}$/.test(Y))throw new j("PARSE_ERROR","Invalid base64 in sf-binary.");return Y}function M8(R){let $=0,Y=R.trim();if(Y[$]!=="(")throw new j("PARSE_ERROR","Inner list must start with '('.");$++;let Z=[];while($<Y.length){if(f(),Y[$]===")"){$++;break}let M=G();Z.push(M),f()}if(Z.length===0)throw new j("PARSE_ERROR","Inner list has no items.");let K={};while($<Y.length){if(f(),Y[$]!==";")break;$++,f();let M=P();if(f(),Y[$]!=="=")throw new j("PARSE_ERROR",`Param ${M} missing '='.`);$++,f();let D=k();K[M]=D}let{created:N,expires:J,keyid:X,nonce:z,tag:U}=K;if(!Number.isInteger(N)||!Number.isInteger(J)||typeof X!=="string")throw new j("PARSE_ERROR","Missing or invalid created/expires/keyid in Signature-Input.");let Q={created:N,expires:J,keyid:X,...typeof z==="string"?{nonce:z}:{},...typeof U==="string"?{tag:U}:{}};return{items:Z,params:Q};function f(){while($<Y.length&&(Y[$]===" "||Y[$]==="\t"))$++}function G(){if(Y[$]!=='"')throw new j("PARSE_ERROR","Expected sf-string.");$++;let M="";while($<Y.length){let D=Y[$];if(D==='"'){$++;break}if(D==="\\"){if($++,$>=Y.length)throw new j("PARSE_ERROR","Bad escape in sf-string.");M+=Y[$],$++;continue}let V=D.charCodeAt(0);if(V<32||V===127)throw new j("PARSE_ERROR","Control char in sf-string.");M+=D,$++}return M}function P(){let M=$;while($<Y.length&&/[A-Za-z0-9_\-*.]/.test(Y[$]))$++;if($===M)throw new j("PARSE_ERROR","Expected token.");return Y.slice(M,$)}function k(){if(Y[$]==='"')return G();let M=$;if(Y[$]==="-")$++;while($<Y.length&&/[0-9]/.test(Y[$]))$++;if($===M)throw new j("PARSE_ERROR","Expected param value.");let D=Number(Y.slice(M,$));if(!Number.isFinite(D))throw new j("PARSE_ERROR","Bad integer param value.");return D}}function pR(R){let $=[],Y="",Z=!1,K=!1;for(let N=0;N<R.length;N++){let J=R[N];if(K){Y+=J,K=!1;continue}if(J==="\\"&&Z){Y+=J,K=!0;continue}if(J==='"'){Y+=J,Z=!Z;continue}if(J===","&&!Z){$.push(Y),Y="";continue}Y+=J}if(Y)$.push(Y);return $}function c(R){if(!/^[a-z][a-z0-9_.-]*$/.test(R))throw new j("PARSE_ERROR",`Invalid signature label: ${R}`)}function cR(R,$){let K=`(${R.map((N)=>I(N)).join(" ")})`;if(K+=`;created=${$.created}`,K+=`;expires=${$.expires}`,$.nonce!=null)K+=`;nonce=${I($.nonce)}`;if($.tag!=null)K+=`;tag=${I($.tag)}`;return K+=`;keyid=${I($.keyid)}`,K}function dR(R){if(!Number.isInteger(R.created)||!Number.isInteger(R.expires))throw new j("INVALID_OPTIONS","created/expires must be integers.");if(R.expires<=R.created)throw new j("INVALID_OPTIONS","expires must be > created.");if(!R.keyid)throw new j("INVALID_OPTIONS","keyid is required.")}function nR(R,$){return c(R),`${R}=${$}`}function hR(R,$){if(c(R),!/^[A-Za-z0-9+/]+={0,2}$/.test($))throw new j("BAD_HEADER_VALUE","Signature must be base64.");return`${R}=:${$}:`}function jR(R,$){if(!R)return $;return`${R}, ${$}`}function I(R){for(let Y=0;Y<R.length;Y++){let Z=R.charCodeAt(Y);if(Z>=0&&Z<=31||Z===127)throw new j("BAD_HEADER_VALUE","sf-string cannot contain control characters.")}return`"${R.replace(/\\/g,"\\\\").replace(/"/g,"\\\"")}"`}function uR(R){return R.map(($)=>$.trim()).filter(Boolean)}function G8(R){let{binding:$,hasQuery:Y,hasBody:Z}=R;if($==="class-bound")return["@authority"];let K=["@authority","@method","@path"];if(Y)K.push("@query");if(Z)K.push("content-digest");return K}function oR(R){let{binding:$,hasQuery:Y,hasBody:Z,providedComponents:K}=R;if($==="request-bound"){let J=G8({binding:$,hasQuery:Y,hasBody:Z});if(!K)return J;let X=uR(K).filter((z)=>!J.includes(z));return J.concat(X)}if(!K)throw new j("INVALID_OPTIONS","components are required for class-bound signatures.");let N=uR(K);if(!N.includes("@authority"))N.unshift("@authority");return N}function i(R){let{request:$,components:Y,signatureParamsValue:Z}=R,K=y($.url),N=[];for(let z of Y){let U=O8({request:$,url:K,component:z});if(/[^\x20-\x7E]/.test(U)||U.includes("\r")||U.includes(`
`))throw new j("BAD_DERIVED_VALUE",`Component ${z} produced invalid characters.`);N.push(`${I(z)}: ${U}`)}let J=`${I("@signature-params")}: ${Z}`,X=N.length?`${N.join(`
`)}
${J}`:J;return yR(X)}function O8(R){let{request:$,url:Y,component:Z}=R;switch(Z){case"@method":{let K=($.method||"GET").toUpperCase();return d(K,"@method"),K}case"@authority":{let K=Y.protocol.replace(":","").toLowerCase(),N=Y.hostname.toLowerCase(),J=Y.port,X=N;if(J){let z=Number(J);if(!(K==="http"&&z===80||K==="https"&&z===443))X=`${N}:${J}`}return d(X,"@authority"),X}case"@path":{let K=Y.pathname||"/";return d(K,"@path"),K}case"@query":{let K=Y.search||"";return d(K,"@query"),K}default:{let K=$.headers.get(Z);if(K==null)throw new j("BAD_HEADER_VALUE",`Required header "${Z}" is missing.`);let N=D8(K);return d(N,Z),N}}}function D8(R){return R.trim().replace(/[ \t]+/g," ")}function d(R,$){if(R.includes("\r")||R.includes(`
`))throw new j("BAD_DERIVED_VALUE",`${$} contains CR/LF.`)}function fR(R,$){if(!Number.isInteger(R))throw new j("INVALID_OPTIONS","chainId must be positive integer.");return`erc8128:${R}:${$.toLowerCase()}`}function MR(R){let $=/^erc8128:(\d+):(0x[a-fA-F0-9]{40})$/.exec(R);if(!$)return null;let Y=Number($[1]);if(!Number.isInteger(Y))return null;return{chainId:Y,address:$[2].toLowerCase()}}async function lR(R){if(typeof R.nonce==="string")return R.nonce;if(typeof R.nonce==="function")return R.nonce();let $=SR(16);return ER($)}async function t(R,$,Y,Z){let K,N,J;if(JR($))N=$,J=Y;else K=$,N=Y,J=Z;let X=J??{},z=gR(R,K),U=X.label??"eth",Q=X.binding??"request-bound",f=X.replay??"non-replayable",G=X.headerMode??"replace",P=X.contentDigest??"auto",k=l(),M=X.created??k,D=X.ttlSeconds??60,V=X.expires??M+D,_=f==="non-replayable"?await lR(X):void 0,E=fR(N.chainId,N.address),n=y(z.url).search.length>0,H=z.body!=null,B=oR({binding:Q,hasQuery:n,hasBody:H,providedComponents:X.components}),T=z;if(B.includes("content-digest"))T=await UR(T,P);else if(Q==="request-bound"&&H)B=[...B,"content-digest"],T=await UR(T,P);let O={created:M,expires:V,keyid:E,..._?{nonce:_}:{}};dR(O);let b=cR(B,O),q=nR(U,b),v=i({request:T,components:B,signatureParamsValue:b}),a=await N.signMessage(v),g=HR(a);if(g.length===0)throw new j("UNSUPPORTED_REQUEST","Signer returned empty signature.");let F=S(g),m=hR(U,F),C=new Headers(T.headers);if(G==="replace")C.set("Signature-Input",q),C.set("Signature",m);else C.set("Signature-Input",jR(C.get("Signature-Input"),q)),C.set("Signature",jR(C.get("Signature"),m));return new Request(T,{headers:C})}async function r(R,$,Y,Z){let K,N,J;if(JR($))N=$,J=Y;else K=$,N=Y,J=Z;let X=await t(R,K,N,J),z=J?.fetch??globalThis.fetch;if(typeof z!=="function")throw new j("UNSUPPORTED_REQUEST","No fetch implementation available. Provide opts.fetch.");return z(X)}var k8=new Set(["method","headers","body","signal","credentials","mode","cache","redirect","referrer","integrity","keepalive","window"]);function q8(R){if(!R||typeof R!=="object")return!1;for(let $ of k8)if($ in R)return!0;return!1}function GR(R,$){if($!==void 0)return{init:R,opts:$};if(q8(R))return{init:R};return{opts:R}}function F8(R,$){let Y=$??{};return{signRequest:async(J,X,z)=>{let{init:U,opts:Q}=GR(X,z),f={...Y,...Q};return t(J,U,R,f)},signedFetch:async(J,X,z)=>{let{init:U,opts:Q}=GR(X,z),f={...Y,...Q};return r(J,U,R,f)},fetch:async(J,X,z)=>{let{init:U,opts:Q}=GR(X,z),f={...Y,...Q};return r(J,U,R,f)}}}function P8(R,$){let Z=`(${R.map((K)=>I(K)).join(" ")})`;if(Z+=";keyid;created;expires",$)Z+=";nonce";return Z}function iR(R){let{requestBoundRequired:$,classBoundPolicies:Y,requireNonce:Z}=R,K=[],N=new Set,J=1,X=(z)=>{let U=z.join("\x00");if(N.has(U))return;N.add(U);let Q=P8(z,Z);K.push(`sig${J}=${Q}`),J++};X($);for(let z of Y)X(z);return K.join(", ")}function tR(R){let{signatureInputHeader:$,signatureHeader:Y,policy:Z}=R,K=Z.label,N=Z.strictLabel??!1;try{let J=mR($),X=AR(Y),z=[];for(let U of J){let Q=X.get(U.label);if(!Q)continue;z.push({label:U.label,components:U.components,params:U.params,signatureParamsValue:U.signatureParamsValue,sigB64:Q})}if(z.length===0)return{ok:!1,result:{ok:!1,reason:"label_not_found"}};if(K!=null&&N){let U=z.filter((Q)=>Q.label===K);if(U.length===0)return{ok:!1,result:{ok:!1,reason:"label_not_found"}};return{ok:!0,selected:U}}return{ok:!0,selected:z}}catch(J){let X=J instanceof Error?J.message:"Failed to parse signature headers.";if(J instanceof j&&J.code==="PARSE_ERROR")return{ok:!1,result:{ok:!1,reason:"bad_signature_input",detail:X}};return{ok:!1,result:{ok:!1,reason:"bad_signature_input",detail:X}}}}function rR(R,$,Y){let Z=OR($,Y);return DR(Z,R)}function OR(R,$){let Y=["@authority","@method","@path"];if(R.hasQuery)Y.push("@query");if(R.hasBody)Y.push("content-digest");if($)for(let Z of $){let K=Z.trim();if(!K)continue;if(!Y.includes(K))Y.push(K)}return Y}function DR(R,$){let Y=new Set($);for(let Z of R)if(!Y.has(Z))return!1;return!0}function s(R){if(!R)return[];let $=[],Y=new Set;for(let Z of R){let K=Z.trim();if(!K||Y.has(K))continue;Y.add(K),$.push(K)}return $}function sR(R){if(!R||R.length===0)return[];if(typeof R[0]==="string")return[s(R)];return R.map(($)=>s($))}function aR(R){if(R.includes("@authority"))return R;return["@authority",...R]}var x8=300;function eR(R,$){let{hasQuery:Y,hasBody:Z,requestBoundExtras:K,requestBoundRequired:N,classBoundPolicies:J}=$,X=[],z=!1;for(let U of R){let{candidate:Q}=U;if(rR(Q.components,{hasQuery:Y,hasBody:Z},K)){X.push({candidate:U,kind:"request-bound",policyLength:N.length});continue}if(z=!0,J.length===0)continue;let G=J.filter((k)=>DR(k,Q.components));if(G.length===0)continue;let P=Math.min(...G.map((k)=>k.length));X.push({candidate:U,kind:"class-bound",policyLength:P})}return{attempts:X,sawClassBound:z}}function R8(R){let{now:$,skew:Y,maxValiditySec:Z,created:K,expires:N}=R;if(typeof K!=="number"||typeof N!=="number"||!Number.isInteger(K)||!Number.isInteger(N)||N<=K)return{ok:!1,reason:"bad_time"};let J=K,X=N;if($+Y<J)return{ok:!1,reason:"not_yet_valid"};if($-Y>X)return{ok:!1,reason:"expired"};let z=typeof Z==="number"&&Number.isFinite(Z)?Z:x8;if(X-J>z)return{ok:!1,reason:"validity_too_long"};return null}function $8(R){let{allowReplayable:$,params:Y,now:Z,nonceStore:K,nonceKey:N,maxNonceWindowSec:J}=R,X=typeof Y.nonce==="string"&&Y.nonce.length>0;if(!X&&!$)return{failure:{ok:!1,reason:"replayable_not_allowed"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};if(X){if(!K)return{failure:{ok:!1,reason:"nonce_required",detail:"nonceStore missing"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};if(J!=null&&typeof Y.created==="number"&&typeof Y.expires==="number"&&Y.expires-Y.created>J)return{failure:{ok:!1,reason:"nonce_window_too_long"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};let z=Y.nonce;if(!z)return{failure:{ok:!1,reason:"nonce_required",detail:"nonce missing"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};return{failure:null,plan:{replayKey:(N??((Q,f)=>`${Q}:${f}`))(Y.keyid,z),replayStore:K,replayTtlSeconds:Math.max(0,(Y.expires??Z)-Z)}}}return{failure:null,plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}}}function Y8(R){let{request:$,components:Y,signatureParamsValue:Z}=R;return i({request:$,components:Y,signatureParamsValue:Z})}var w8=3;async function kR(R,$,Y,Z,K){let N={...Z,verifyMessage:$,nonceStore:Y},J=N.label,X=N.strictLabel??!1,z=N.now?.()??l(),U=N.clockSkewSec??0,Q=N.replayable??!1,G=y(R.url).search.length>0,P=R.body!=null,k=s(N.additionalRequestBoundComponents),M=OR({hasQuery:G,hasBody:P},k),D=sR(N.classBoundPolicies).map((q)=>aR(q));if(K)try{let q=iR({requestBoundRequired:M,classBoundPolicies:D,requireNonce:!Q});K("Accept-Signature",q)}catch{}let V=R.headers.get("Signature-Input"),_=R.headers.get("Signature");if(!V||!_)return{ok:!1,reason:"missing_headers"};let E=tR({signatureInputHeader:V,signatureHeader:_,policy:{label:J,strictLabel:X}});if(!E.ok)return E.result;let n=E.selected.map((q)=>{let v=MR(q.params.keyid);if(!v)return null;return{candidate:q,key:v}}).filter((q)=>q!=null);if(n.length===0)return{ok:!1,reason:"bad_keyid"};let{attempts:H,sawClassBound:B}=eR(n,{hasQuery:G,hasBody:P,requestBoundExtras:k,requestBoundRequired:M,classBoundPolicies:D});if(H.length===0){if(B&&D.length>0)return{ok:!1,reason:"class_bound_not_allowed"};return{ok:!1,reason:"not_request_bound"}}let T=typeof N.maxSignatureVerifications==="number"&&Number.isFinite(N.maxSignatureVerifications)&&N.maxSignatureVerifications>0?Math.floor(N.maxSignatureVerifications):w8,O={ok:!1,reason:"bad_signature"},b=0;for(let q of H){if(b>=T)break;b++;let{candidate:v,key:a}=q.candidate,{components:g,params:F,signatureParamsValue:m,sigB64:C,label:qR}=v,{chainId:K8,address:FR}=a,e=!F.nonce||F.nonce.length===0,PR=R8({now:z,skew:U,maxValiditySec:N.maxValiditySec,created:F.created,expires:F.expires});if(PR){O=PR;continue}let{failure:xR,plan:A}=$8({allowReplayable:Q,params:F,now:z,nonceStore:N.nonceStore,nonceKey:N.nonceKey,maxNonceWindowSec:N.maxNonceWindowSec});if(xR){O=xR;continue}if(e){if(!(typeof N.replayableNotBefore==="function"||typeof N.replayableInvalidated==="function")){O={ok:!1,reason:"replayable_invalidation_required"};continue}if(typeof N.replayableNotBefore==="function"){let p=await N.replayableNotBefore(F.keyid);if(typeof p==="number"&&Number.isFinite(p)&&F.created<p){O={ok:!1,reason:"replayable_not_before"};continue}}}if(g.includes("content-digest")){if(!R.headers.get("content-digest")){O={ok:!1,reason:"digest_required"};continue}if(!await bR(R)){O={ok:!1,reason:"digest_mismatch"};continue}}let wR=Y8({request:R,components:g,signatureParamsValue:m}),RR=_R(C);if(!RR||RR.length===0){O={ok:!1,reason:"bad_signature_bytes"};continue}let TR=QR(RR);if(e&&typeof N.replayableInvalidated==="function"){if(await N.replayableInvalidated({keyid:F.keyid,created:F.created,expires:F.expires,label:qR,signature:TR,signatureBase:wR,signatureParamsValue:m})){O={ok:!1,reason:"replayable_invalidated"};continue}}let CR=N.verifyMessage;if(!CR){O={ok:!1,reason:"bad_signature_check",detail:"verifyMessage missing in policy"};continue}try{if(await CR({address:FR,message:{raw:QR(wR)},signature:TR})){if(A.replayKey&&A.replayStore){if(!await A.replayStore.consume(A.replayKey,A.replayTtlSeconds)){O={ok:!1,reason:"replay"};continue}}return{ok:!0,address:FR,chainId:K8,label:qR,components:g,params:F,replayable:e,binding:q.kind}}}catch{O={ok:!1,reason:"bad_signature_check"};continue}O={ok:!1,reason:"bad_signature"}}return O}function T8(R,$,Y){let Z=Y??{};return{verifyRequest:async(N,J,X)=>{let z={...Z,...J};return kR(N,R,$,z,X)}}}export{kR as verifyRequest,r as signedFetch,t as signRequest,MR as parseKeyId,fR as formatKeyId,T8 as createVerifierClient,F8 as createSignerClient,j as Erc8128Error};

//# debugId=BCD0ACB208BE672B64756E2164756E21
